---
title: "texas_blackout"
format: html
editor_options: 
  chunk_output_type: console
---
In early 2021, Texas experienced three extreme weather events resulting in a major power grid blackout. This blackout caused inhospitable conditions for many homes in Texas, with shortages of food, water, and heat. In this project, we will quantify the amount of homes in Houston that were affected by the outage, and investigate whether these impacts disproportionately affected certain census groups such as income. 

```{r}
# load packages
library(tidyverse)
library(dplyr)
library(here)
library(sf)
library(stars)
library(terra)
library(raster)
library(tmap)
```

```{r}
# read in data
query_road <- "SELECT * FROM gis_osm_roads_free_1 WHERE fclass='motorway'"
roads <- st_read(here("data", "gis_osm_roads_free_1.gpkg"), query = query_road)

query_houses <- "SELECT * FROM gis_osm_buildings_a_free_1 WHERE (type IS NULL AND name IS NULL) OR type in ('residential', 'apartments', 'house', 'static_caravan', 'detached')"
houses <- st_read(here("data", "gis_osm_buildings_a_free_1.gpkg"), query = query_houses)

st_layers(here("data", "ACS_2019_5YR_TRACT_48_TEXAS.gdb"))
socioeconomic_geoid <- st_read(here("data", "ACS_2019_5YR_TRACT_48_TEXAS.gdb"), layer = "ACS_2019_5YR_TRACT_48_TEXAS")
socioeconomic <- st_read(here("data", "ACS_2019_5YR_TRACT_48_TEXAS.gdb"), layer = "X19_INCOME")

light5_207 <- read_stars(here("data", "VNP46A1", "VNP46A1.A2021038.h08v05.001.2021039064328.tif"))
light6_207<- read_stars(here("data", "VNP46A1", "VNP46A1.A2021038.h08v06.001.2021039064329.tif"))
light5_216 <- read_stars(here("data", "VNP46A1", "VNP46A1.A2021047.h08v05.001.2021048091106.tif"))
light6_216 <- read_stars(here("data", "VNP46A1", "VNP46A1.A2021047.h08v06.001.2021048091105.tif"))
```

Step 1: Find locations that experienced a blackout by creating a mask

```{r}
# join shapefiles of each tile for each day
light_207 <- st_mosaic(light5_207, light6_207)
light_216 <- st_mosaic(light5_216, light6_216)

# find the change in light intensity before and after the storm
light_change <- light_207 - light_216
```

```{r}
# define bbox of Houston area
bbox_light <- st_bbox(c(xmin = -96.5, ymin = 29, xmax = -94.5, ymax = 30.5), crs = st_crs(light_207))
# transform bbox into sf object
bbox_light <- st_as_sfc(bbox_light)
# double check crs match before cropping
st_crs(bbox_light) == st_crs(light_207)

# crop light intensities for each day to just Houston area
cropped_light_207 <- st_crop(light_207, bbox_light)
cropped_light_216 <- st_crop(light_216, bbox_light)

# map each day to see the light change
map_207 <- tm_shape(cropped_light_207) +
  tm_raster(palette = "Greys",
            breaks = c(0, 100, 200, 500, 800, 1000, Inf),
            title = "Night light intensity 
(200 nW cm-2sr-1)")

map_216 <- tm_shape(cropped_light_216) +
  tm_raster(palette = "Greys",
            breaks = c(0, 100, 200, 500, 800, 1000, Inf),
            title = "Night light intensity 
(200 nW cm-2sr-1)")

tmap_arrange(map_207, map_216, nrow = 1)
```

```{r}
# transform from stars to raster object
light_change <- rast(light_change)

# define matrix for values greater than 200 nw
rcl <- matrix(c(-Inf, 200, NA,
                200, Inf, TRUE),
              ncol = 3, byrow = TRUE)

# apply mask for values > 200 nW
reclass_light <- classify(light_change, rcl = rcl)
reclass_light
```

```{r}
# check crs of masked light dataframe
st_crs(reclass_light)$epsg

# transform from rast to sf object to vectorize
light_change_vector <- reclass_light %>% 
  st_as_stars() %>% 
  st_as_sf() %>% 
  st_make_valid()

# check type of vectorized data frame
class(light_change_vector)
```
  
- crop (spatially subset) the blackout mask to the Houston area as defined by the following       coordinates: 
  (-96.5, 29), (-96.5, 30.5), (-94.5, 30.5), (-94.5, 29)
  
bbox --> sf object
```{r}
# redefine bbox for Houston area
bbox_crop <- st_bbox(c(xmin = -96.5, ymin = 29, xmax = -94.5, ymax = 30.5), crs = st_crs(light_change_vector))
# transform bbox to sf object
bbox_crop <- st_as_sfc(bbox_crop)
# double check class
class(bbox_crop)
# double check crs match
st_crs(bbox_crop) == st_crs(light_change_vector)

# crop vectorized light object to just Houston area
cropped_light_diff <- st_crop(light_change_vector, bbox_crop)
```
  
```{r}
# reproject vectorized data to NAD83 crs
cropped_light_diff <- st_transform(cropped_light_diff, crs = "epsg:3083")
st_crs(cropped_light_diff)$epsg
```

```{r}
# plot Houston that experienced a blackout
tm_shape(cropped_light_diff) +
  tm_fill(fill = "black") +
  tm_title("Areas of Houston experiencing a blackout")
```

Step 2: Exclude highways from analysis

```{r}
# check units of roads and transform
st_crs(roads, parameters = TRUE)$units_gdal # its in degree units
roads <- st_transform(roads, st_crs(cropped_light_diff))
st_crs(roads, parameters = TRUE)$units_gdal # now it is in metre

# create buffer of 200 m around roadways
roads_200 <- st_buffer(roads, dist = 200)
# join with roads to treat as one road 200m large
roads_200 <- st_union(roads_200)
# plot quickly to check it worked
tm_shape(roads) +
  tm_lines() 
tm_shape(roads_200) +
  tm_lines()
```
  
- find areas that experienced blackouts that are further than 200m from a highway
```{r}
# check CRS match
st_crs(roads_200)$epsg == st_crs(cropped_light_diff)$epsg

# find areas of Houston that experienced blackout that are not near roads
light_road_clip <- st_difference(cropped_light_diff, roads_200)

# plot to see where they overlapped
tm_shape(light_road_clip) +
  tm_polygons() +
tm_shape(roads_200) +
  tm_lines(col_alpha = 0.5, 
           col = "red") +
  tm_title("Homes that experienced a blackout in Houston, Texas") +
  tm_title("200m away from highways", size = 0.9) +
  tm_add_legend(type = "lines", 
                labels = c("200m highway buffer"),
                col = c("red")) +
  tm_layout(legend.position = c("left", "bottom"))
```

Step 3: Identify homes that experienced blackouts by combining the locations of homes and blackouts

```{r}
# check crs match
st_crs(light_road_clip) == st_crs(houses) 
# transform crs to match 
houses <- st_transform(houses, st_crs(light_road_clip))
# check crs match
st_crs(light_road_clip) == st_crs(houses) 

# find homes that experienced a blackout
homes_blackout <- st_intersection(light_road_clip, houses)
```

```{r}
# plot homes in Houston that experienced a blackout
tm_shape(homes_blackout) +
  tm_polygons()
```

```{r}
# find number of homes that experienced a blackout
nrow(homes_blackout)
```

Step 4: Identify the census tracts likely impacted by blackout
- identify homes that overlap with areas that experienced blackouts
```{r}
# check crs of socioeconomic data
st_crs(socioeconomic_geoid)$epsg
# transform to match NAD83
socioeconomic_geoid <- st_transform(socioeconomic_geoid, 
                                    crs = st_crs(homes_blackout))
# rename GEOID column to prep for joining
socioeconomic <- socioeconomic %>% 
  rename("GEOID_Data" = "GEOID")
```

```{r}
# join shapefile with socioeconomic data
socioeconomic_join <- left_join(socioeconomic_geoid, socioeconomic,
                                by = "GEOID_Data")
# transform to sf object
socioeconomic_join <- st_as_sf(socioeconomic_join)
# check the column we want was populated with data
socioeconomic_join$B19013e1

# select for only the columns we want
socioeconomic_join <- socioeconomic_join[, c("TRACTCE", "GEOID_Data", "B19013e1")]
```

```{r}
homes_blackout_TF <- houses %>% 
  mutate(blackout = osm_id %in% homes_blackout$osm_id)

# join socioeconomic data to homes that experienced a blackout
socioeconomic_homes <- st_intersection(homes_blackout_TF, socioeconomic_join)
```

- a map of the census tracts in Houston that lost power
```{r}
tm_shape(socioeconomic_homes) +
  tm_fill(fill = "TRACTCE")
```

- a plot comparing the distributions of median household income for census tracts that did and did not experience blackouts
```{r}
ggplot(socioeconomic_homes, aes(x = B19013e1)) +
  geom_histogram() +
  facet_wrap(~blackout)
```

Step 5: Conclusions
- a brief reflection (approx. 100 words) summarizing your results and discussing any limitations to this study